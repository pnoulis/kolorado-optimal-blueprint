#!/bin/bash

# Author
export PKG_AUTHOR_NAME="pavlos noulis"
export PKG_AUTHOR_ID="pnoulis"
export PKG_AUTHOR_EMAIL="pavlos.noulis@gmail.com"
export PKG_AUTHOR_HOME_URL="https://github.com/pnoulis"
# Package
export PKG_NAME="kolorado-optimal-blueprint"
export PKG_ID="boptimus"
export PKG_PRETTY_NAME="kolorado optimal blueprint"
export PKG_VERSION="0.0.1"
export PKG_VERSION_ID="0.0.1"
export PKG_VERSION_CODENAME=""
export PKG_TARNAME="kolorado-optimal-blueprint-v0.0.1"
export PKG_REPOSITORY_TYPE="git"
export PKG_REPOSITORY_DOMAIN="github.com"
export PKG_REPONAME="kolorado-optimal-blueprint"
export PKG_REPOSITORY_PATH="pnoulis/kolorado-optimal-blueprint"
export PKG_REPOSITORY_URL="https://github.com/pnoulis/kolorado-optimal-blueprint"
export PKG_HOME_URL="https://github.com/pnoulis/kolorado-optimal-blueprint"
export PKG_DOCUMENTATION_URL="https://github.com/pnoulis/kolorado-optimal-blueprint#readme"
export PKG_BUG_REPORT_URL="https://github.com/pnoulis/kolorado-optimal-blueprint/issues"
export PKG_SUPPORT_URL="https://github.com/pnoulis/kolorado-optimal-blueprint"


buildir=$(realpath -m ./var)
mkdir $buildir 2>/dev/null

# server options
server_mode=development
server_url=http://localhost
server_port=8080
db_url=$(realpath -m $buildir/boptimus.db)

# website options
website_mode=development
website_url=http://localhost
website_port=3000

# configure db
cp -u packages/db/seed/* $buildir
rm -f $db_url
sqlite3 $db_url < packages/db/db-create.sql
sqlite3 $db_url < packages/db/db-seed.sql


# Configure website
cp -u packages/website/public/* $buildir
cp -u packages/website/src/*.ejs $buildir
npx ejs --rm-whitespace packages/website/src/blueprints.ejs -f $buildir/blueprints.json > $buildir/blueprints.html
npx ejs --rm-whitespace packages/website/src/shapes.ejs -f $buildir/shapes.json > $buildir/shapes.html
npx ejs --rm-whitespace packages/website/src/home.ejs > $buildir/index.html
npx esbuild --bundle --target=esnext packages/website/src/main.js > $buildir/main.js

# Configure server
cd packages/server
./configure --mode=$server_mode \
            --url=$server_url \
            --port=$server_port \
            --db-url=$db_url \
            --publicdir=$buildir \
            --statedir=$buildir
make dev

# docker compose up -d
